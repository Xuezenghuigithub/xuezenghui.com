---
title: "D3.jsâ€”â€”æ•°æ®å¯è§†åŒ–åº“ç‹è€…ï¼ŒSVG ä¸­çš„ jQuery"
date: "2019-10-13T00:00:00+08:00"
tags: ["D3.js"]
discripion: "D3.js å­¦ä¹ ç¬”è®°"
keywords: ["D3.js", "æ•°æ®å¯è§†åŒ–"]
categories: ["Tech"]
toc: true
---

## éœ€è¦äº†è§£çš„å‡ ä¸ªæ¦‚å¿µ
### æ•°æ®å¯è§†åŒ–
- [å“ˆä½›å¤§å­¦ä¸–ç•Œè´¸æ˜“æ•°æ®å¯è§†åŒ–](http://globe.cid.harvard.edu/)
- [React+D3.js Demo](http://www.a4z.cn/pui/ant-admin.html#/)

åŸºäºWebçš„æ•°æ®å¯è§†åŒ–æŒ‡çš„æ˜¯åœ¨ç½‘é¡µä¸­æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡æŠ¥è¡¨ï¼Œä»è€Œå¯ä»¥æ›´ç›´è§‚åœ°äº†è§£æ•°æ®çš„èµ°å‘å’Œè¶‹åŠ¿ï¼Œå¦‚å›¾è¡¨ã€å›¾è°±ã€åœ°å›¾ã€å…³ç³»å›¾ã€ç«‹ä½“å›¾ã€‚

æ•°æ®å¯è§†åŒ–çš„å±•ç°æ–¹å¼ä»ä»¥å¾€çš„ Flash æŠ€æœ¯ã€IE çš„ vml è¯­è¨€å‘å±•è‡³å¦‚ä»Šè§„èŒƒç»Ÿä¸€çš„ HTML5 æŠ€æœ¯ç‚¹â€”â€”**Canvas** å’Œ **SVG**ã€‚
### [SVG](https://www.w3school.com.cn/svg/index.asp)
å¯ç¼©æ”¾çŸ¢é‡å›¾å½¢ï¼ŒåŸºäº XMLã€‚

![SVG_Axis.png](http://blog.xuezenghui.com/D3.js/SVG_Axis.png "SVGåæ ‡è½´")

> 1. SVG å›¾å½¢ç»ƒä¹ ï¼š[SVG å›¾å½¢å®ä¾‹](https://www.runoob.com/svg/svg-examples.html)
> 2. è¦ä½¿ç”¨ SVG å°±è¦è€ƒè™‘åˆ°æµè§ˆå™¨çš„å…¼å®¹é—®é¢˜ï¼Œ[Can I Use](https://www.caniuse.com)æ˜¯ä¸€ä¸ªæŸ¥çœ‹æµè§ˆå™¨å…¼å®¹çŠ¶æ€çš„å¼ºåŠ›å·¥å…·

## D3.js
### ç®€ä»‹
Data Driven Ducumentsï¼ŒåŸºäº**æ•°æ®é©±åŠ¨æ–‡æ¡£**çš„ JavaScript åº“ï¼Œç”¨äºç½‘é¡µä½œå›¾ã€ç”Ÿæˆäº’åŠ¨å›¾å½¢ï¼Œæ˜¯ä¸€ä¸ªä¼˜ç§€çš„å¯è§†åŒ–åº“ã€‚D3.js ä¸éœ€è¦ä½ ä½¿ç”¨å“ªä¸ªç‰¹å®šçš„æ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦èƒ½å†™ JavaScript å°±èƒ½ä½¿ç”¨ D3.jsï¼Œå½“ç„¶æ˜¯è¦åœ¨æµè§ˆå™¨å…¼å®¹çš„å‰æä¸‹äº†ã€‚
### ä¼˜åŠ¿
- **å ªç§° SVG ä¸­çš„ jQueryï¼Œæ“ä½œ SVG æä¸ºæ–¹ä¾¿ï¼Œå½“ç„¶ Canvas ä¹Ÿæ”¯æŒ**

    æˆªæ­¢ç›®å‰æ¥è¯´ï¼ŒD3 æ˜¯æ“ä½œ SVG æœ€ä¸ºæ–¹ä¾¿çš„ä¸€ä¸ªåº“ï¼Œå ªæ¯” jQuery å’Œ JavaScript çš„å…³ç³»ï¼Œå½“ç„¶è¿™ä¸æ˜¯è¯´ D3 åªèƒ½æ“ä½œ SVGï¼Œåœ¨ v3 ä¹‹åçš„ v4 ç‰ˆæœ¬å¼€å§‹ D3 å°±å·²ç»æ”¯æŒ Canvas äº†ï¼Œä½†æ˜¯æ”¯æŒä¸ä»£è¡¨æ“…é•¿ï¼Œä¸»è¦çš„å¤„ç†ç›®æ ‡è¿˜æ˜¯ SVGã€‚

- **ç›¸æ¯”äº [Echarts](https://www.echartsjs.com/zh/index.html) è¿™ç§æ¡†æ¶å¼å·¥å…·æ¥è¯´ï¼ŒD3.js çš„è‡ªç”±åº¦æ›´é«˜ï¼Œä½†ç›¸å¯¹çš„å­¦ä¹ æˆæœ¬ä¹Ÿä¼šå˜é«˜**

    chart ç±»çš„å·¥å…·ï¼ˆHighchartã€Echartsï¼‰å›ºç„¶ç®€å•æ˜“ä¸Šæ‰‹ï¼Œä½†æ˜¯è¿™ç±»éƒ½æ˜¯â€œæ¡†æ¶å¼å·¥å…·â€ï¼Œå’Œâ€œåº“â€åŒºåˆ«è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½ éœ€è¦è£…ä¿®è‡ªå®¶æˆ¿å­ï¼Œä¸€ç§æ–¹å¼æ˜¯æä¾›ç»™ä½ è£…ä¿®ä¼šç”¨åˆ°æ‰€æœ‰å·¥å…·å¹¶æ•™ä¼šä½ æ‰€æœ‰è£…ä¿®æ–¹æ³•ï¼Œè£…ä¿®é£æ ¼å°±ä»»å›å‘æŒ¥äº†ï¼Œè¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯ç»™ä½ å‡ºå‡ ä¸ªæ ·æœ¬æˆ¿ï¼Œè‡ªå·±ä»ä¸­é€‰æ‹©ï¼Œè¿™å°±æ˜¯â€œåº“â€å’Œâ€œæ¡†æ¶å¼å·¥å…·â€çš„åŒºåˆ«äº†ï¼Œæ‰€ä»¥ï¼Œç©è½¬ D3 åé™åˆ¶å›¾å½¢æ ·å¼çš„å°±åªæœ‰ä½ çš„æƒ³è±¡åŠ›äº†ã€‚

- **æ“ä½œDOMæå…¶å¼ºå¤§**

    æ¯«ä¸å¤¸å¼ çš„è¯´ï¼Œå¦‚æœä½ å­¦ä¹ è¿‡ jQueryï¼ŒD3 ä½ å·²ç»ä¼šäº†â…“ã€‚ç”šè‡³ç½‘ä¸Šæœ‰äººè¯´ D3 å¯ä»¥æ›¿ä»£ jQueryï¼Œè™½ç„¶ä¸ç°å®ï¼Œä½†è¿™ä¸ªè¯´æ³•ç¡®å®å¾—ç›Šäº D3 æå¼ºçš„æ“ä½œ DOMèƒ½åŠ›ã€‚

## å…¥é—¨å®ä¾‹â€”â€”ç›´æ–¹å›¾
### æ–°å»ºä¸€ä¸ª HTML5 æ–‡ä»¶

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>D3.js</title>
</head>
<body>
</body>
</html>
```
### å¼•å…¥ D3.js
`<script src="http://d3js.org/d3.v3.min.js"></script>`
### åˆ›å»º div ç”¨æ¥å±•ç¤º SVG
`<div id='svg'></div>`
### ä½¿ç”¨ D3.js çš„è¯­æ³•ç»˜åˆ¶ SVG
```javascript
const dataset = [223, 34, 55, 66, 99, 276, 123]; // å®šä¹‰æ•°æ®
const height = 400; // å®šä¹‰SVGçš„é«˜
const width = 400; // å®šä¹‰SVGçš„å®½
const svg = d3.select("#svg").append("svg")
    .attr("height", height)
    .attr("width", width);

const padding = {
    top: 20,
    left: 20,
    right: 20,
    bottom: 20
};
const rectStep = 35; // å®šä¹‰é—´éš”
const rectWidth = 30; // å®šä¹‰çŸ©å½¢å®½åº¦
svg.selectAll("rect").data(dataset).enter().append("rect") // æ“ä½œçŸ©å½¢
    .attr("fill", "yellow") // å¡«å……é¢œè‰²
    .attr("x", (d, i) => padding.left + i * rectStep) // è®¾ç½®çŸ©å½¢xè½´åæ ‡
    .attr("y", (d, i) => height - padding.bottom - d) // yè½´åæ ‡
    .attr("width", rectWidth) // çŸ©å½¢å®½åº¦
    .attr("height", d => d); // é«˜åº¦

const text = svg.selectAll("text").data(dataset).enter().append("text") // æ·»åŠ æ–‡æœ¬
    .attr("fill", "pink") // æ–‡æœ¬é¢œè‰²
    .attr("font-size", "16px")
    .attr("text-anchor", "middle") // å±…ä¸­æ˜¾ç¤º
    .attr("x", (d, i) => padding.left + i * rectStep)
    .attr("y", (d, i) => height - padding.bottom - d)
    .text(d => d) // æ–‡æœ¬å†…å®¹
    .attr("dx", rectWidth / 2) // xè½´åç§»é‡
    .attr('dy', "-10px") // yè½´åç§»é‡
```

![interval&width.png](http://blog.xuezenghui.com/D3.js/interval&width.png "é—´è·rectStepå’Œå®½åº¦rectWidthè¯´æ˜")

![result.png](http://blog.xuezenghui.com/D3.js/result.png "æ•ˆæœå›¾")


> âš ï¸æ³¨æ„ï¼š
> 
> 1. çŸ©å½¢çš„ xã€y åæ ‡ä»¥çŸ©å½¢çš„å·¦ä¸Šè§’ä¸ºä¸­å¿ƒç‚¹
> 2. SVG å¡«å……èƒŒæ™¯é¢œè‰²ä½¿ç”¨çš„æ˜¯`fill`å±æ€§
> 3. çŸ©å½¢ä¹‹é—´çš„é—´éš”ä¸º x è½´çš„å·®å€¼

### æ¶‰åŠçš„APIï¼š

|API|å«ä¹‰|ç¤ºä¾‹|
|---|---|---|
|.select|é€‰æ‹©å…ƒç´ |d3.select("#id")|
|.selectAll|é€‰æ‹©å¤šä¸ªå…ƒç´ |d3.selectAll("#id")|
|.append|æ·»åŠ å…ƒç´ |.append("svg")|
|.attr|æ·»åŠ å±æ€§|.attr("width","400")|
|.data|ç»‘å®šæ•°æ®|.data([45,64])|
|.enter|å½“DOMå…ƒç´ æ•°é‡å°‘äºdataçš„æ•°é‡æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå…ƒç´ |.enter()|
|.text|è®¾ç½®æ–‡æœ¬å†…å®¹|.text(d => d)|

## æ¯”ä¾‹å°ºå’Œåæ ‡è½´
### æ¯”ä¾‹å°º
å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸Šæ¬¡ç›´æ–¹å›¾ä¸­æ˜¯æ€æ ·è®¾ç½®â€œæŸ±å­â€çš„é«˜åº¦çš„ï¼š

```js
svg.selectAll("rect").data(dataset).enter().append("rect") // æ“ä½œçŸ©å½¢
    .attr("fill", "yellow") // å¡«å……é¢œè‰²
    .attr("x", (d, i) => padding.left + i * rectStep) // è®¾ç½®çŸ©å½¢xè½´åæ ‡
    .attr("y", (d, i) => height - padding.bottom - d) // yè½´åæ ‡
    .attr("width", rectWidth) // çŸ©å½¢å®½åº¦
    .attr("height", d => d); // é«˜åº¦
```
å¯¹çš„ï¼Œè¿™é‡Œæ˜¯ç›´æ¥ä½¿ç”¨æ•°å€¼çš„å¤§å°æ¥è¡¨ç¤ºâ€œæŸ±å­â€çš„é«˜åº¦ï¼Œä½ å¯èƒ½ä¼šè¡¨ç¤ºï¼šæ˜¾ç¤ºçš„é«˜åº¦è‚¯å®šæ˜¯å’Œæ•°å€¼çš„å¤§å°æœ‰å…³ç³»å•Šï¼å¯¹ï¼é—®é¢˜å°±åœ¨è¿™ä¸ª..å…³ç³»..ä¸Šï¼Œå¦‚æœä¸€å®šæ˜¯è¿™æ ·ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œé‚£æ•°å€¼æ˜¯è¿™æ ·å‘¢ï¼š`[ 2.5 , 2.1 , 1.7 , 1.3 , 0.9 ]`ï¼Œè¿™æ ·å‘¢ï¼š`[ 2500, 2100, 1700, 1300, 900 ]`ã€‚

è¿™æ ·çš„æ•°æ®å¯è§†åŒ–æ˜¯æ¯«æ— å¯è¯»æ€§ã€ä¹Ÿæ˜¯ç»ä¸å¯å–çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ç§..è®¡ç®—å…³ç³»..ï¼Œ**èƒ½å¤Ÿå°†æŸä¸€åŒºåŸŸçš„å€¼æ˜ å°„åˆ°å¦ä¸€åŒºåŸŸï¼Œå…¶å¤§å°å…³ç³»ä¸å˜**ï¼Œè¿™å°±æ˜¯ D3 ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µâ€”â€”æ¯”ä¾‹å°ºã€‚
#### scaleLinear()çº¿æ€§æ¯”ä¾‹å°º
çº¿æ€§æ¯”ä¾‹å°ºä¸­ï¼Œå®šä¹‰åŸŸå’Œå€¼åŸŸéƒ½æ˜¯è¿ç»­çš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚

##### ä¾‹å­
```js
var dataset = [1.2, 2.3, 0.9, 1.5, 3.3];
```

- éœ€æ±‚
	- å°†æœ€å°çš„å€¼æ˜ å°„ä¸º0ï¼Œå°†æœ€å¤§çš„å€¼æ˜ å°„ä¸º300ã€‚

- å®šä¹‰æ¯”ä¾‹å°ºï¼š
	```js
	const linear = d3
	    .scaleLinear()
	    .domain([d3.min(dataset), d3.max(dataset)])
	    .range([0, 300])
	```
- ç»“æœ
	
	```js
	linear(0.9) // è¾“å‡º:0
	linear(2.3) // è¾“å‡º:175
	linear(3.3) // è¾“å‡º:300
	```
- è§£é‡Š
	- `.domain()`ä¸ºå®šä¹‰åŸŸï¼Œ`.range()`ä¸ºå€¼åŸŸ
	- `d3.min()`å’Œ`d3.max()`è¿”å›æ•°ç»„ä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼

![scaleLinear.png](http://blog.xuezenghui.com/D3.js/scaleLinear.png "å®šä¹‰åŸŸä¸å€¼åŸŸçš„æ˜ å°„å…³ç³»")
	
#### d3.scaleOrdinal()åºæ•°æ¯”ä¾‹å°º
è¾“å…¥åŸŸå’Œè¾“å‡ºåŸŸéƒ½æ˜¯ç¦»æ•£çš„æ•°æ®ï¼Œä¸è¿ç»­ï¼Œå…¶æ•°æ®æ˜¯åºæ•°å…³ç³»ã€‚
##### ä¾‹å­
```js
const dataset = [45, 34, 145, 11, 78];
const color = ['pink', 'blue', 'yellow', 'black', 'green'];
```
- éœ€æ±‚
	- 45å¯¹åº” pinkï¼Œ34å¯¹åº” blueï¼Œä»¥æ­¤ç±»æ¨ã€‚
- å®šä¹‰æ¯”ä¾‹å°º
	
	```js
	const ordinal = d3
		.scaleOrdinal()
		.domain(dataset)
		.range(color)
	```
- ç»“æœ
	
	```js
	ordinal(45) // è¾“å‡º:color
	ordinal(145) // è¾“å‡º:yellow
	ordinal(78) // è¾“å‡º:green
	```

![scaleOrdinal.png](http://blog.xuezenghui.com/D3.js/scaleOrdinal.png "å®šä¹‰åŸŸä¸å€¼åŸŸçš„æ˜ å°„å…³ç³»")

> v3 ä»¥ä¸‹ç‰ˆæœ¬å’Œ v3 ä»¥ä¸Šç‰ˆæœ¬æ¯”ä¾‹å°ºçš„å†™æ³•ä¸åŒï¼Œè¯¦æƒ…è¯·å‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚

### åæ ‡è½´
åŸºæœ¬æ¯ç§å›¾è¡¨éƒ½éœ€è¦åæ ‡è½´ï¼Œä½†æ˜¯ SVG ä¸­å¹¶æ²¡æœ‰ç°æˆçš„å…ƒç´ ï¼Œè€Œæ˜¯éœ€è¦ç”±å…¶å®ƒå›¾å½¢æ¥ç»„æˆâ€”â€”..åˆ»åº¦.. å’Œ ..ç›´çº¿..ã€‚

```js
// å¼•å…¥D3çš„v5ç‰ˆæœ¬ï¼š`<script src="https://d3js.org/d3.v5.min.js"></script>`

const dataset = [223, 34, 55, 66, 99, 276, 123]; // å®šä¹‰æ•°æ®
const height = 400; // å®šä¹‰SVGçš„é«˜
const width = 400; // å®šä¹‰SVGçš„å®½
// const 
const svg = d3.select("#svg").append("svg")
    .attr("height", height)
    .attr("width", width);

const padding = { // å®šä¹‰é—´è·
    top: 50,
    left: 50,
    right: 50,
    bottom: 50
};
const rectStep = 35; // å®šä¹‰é—´éš”
const rectWidth = 30; // å®šä¹‰çŸ©å½¢å®½åº¦
const xAxisWidth = width - padding.left - padding.right; // xè½´é•¿åº¦
const yAxisWidth = height - padding.top - padding.bottom; // yè½´é•¿åº¦
const xScale = d3 // xè½´æ¯”ä¾‹å°º
    .scaleBand() // åºæ•°æ¯”ä¾‹å°º
    .domain(dataset.map((d, i) => i)) // å®šä¹‰åŸŸ
    .range([0, xAxisWidth]) // å€¼åŸŸ
    .padding(0.1); // åæ ‡è½´é—´è·

const yScale = d3 // yè½´æ¯”ä¾‹å°º
    .scaleLinear() // çº¿æ€§æ¯”ä¾‹å°º
    .domain([0, d3.max(dataset)]) // å®šä¹‰åŸŸ
    .rangeRound([yAxisWidth, 0]); // å€¼åŸŸ

const genRect = obj => { // è®¾ç½®çŸ©å½¢çš„å‡½æ•°
    obj.attr("fill", "yellow") // å¡«å……é¢œè‰²
        .attr("x", (d, i) => padding.left + xScale(i)) // è®¾ç½®çŸ©å½¢xè½´åæ ‡                
        .attr("y", (d, i) => height - padding.bottom - (yScale(0) - yScale(d))) // yè½´åæ ‡
        .attr("width", xScale.bandwidth()) // çŸ©å½¢å®½åº¦
        .attr("height", d => yScale(0) - yScale(d)); // é«˜åº¦
}

const genText = obj => { // è®¾ç½®æ–‡æœ¬çš„å‡½æ•°
    obj.attr("fill", "pink") // æ–‡æœ¬é¢œè‰²
        .attr("class", "number")
        .attr("font-size", "16px")
        .attr("text-anchor", "middle") // å±…ä¸­æ˜¾ç¤º
        .attr("x", (d, i) => padding.left + xScale(i)) // è®¾ç½®çŸ©å½¢xè½´åæ ‡                
        .attr("y", (d, i) => height - padding.bottom - (yScale(0) - yScale(d))) // yè½´åæ ‡
        .text(d => d) // æ–‡æœ¬å†…å®¹
        .attr("dx", xScale.bandwidth() / 2) // xè½´åç§»é‡
        .attr('dy', "-10px") // yè½´åç§»é‡
}

const init = dataset => { // åˆå§‹åŒ–æ•°æ®å‡½æ•°
    genRect(svg.selectAll("rect").data(dataset).enter().append("rect"));
    genText(svg.selectAll("text").data(dataset).enter().append("text"));
}
init(dataset);

const xAxis = d3.axisBottom(xScale); // xè½´
const gx = svg // å­˜æ”¾xè½´çš„å®¹å™¨
    .append("g")
    .attr("transform", `translate(${padding.left},${height-padding.bottom})`); // é»˜è®¤æ˜¾ç¤ºåœ¨ä¸Šæ–¹æ˜¾ç¤ºï¼Œè¦ä½¿ä»–åç§»åˆ°ä¸‹é¢
gx.call(xAxis); // å°†xè½´æ”¾è¿›å®¹å™¨

const yAxis = d3.axisLeft(yScale); // yè½´
const gy = svg
    .append("g")
    .attr("transform", `translate(${padding.left},${height-yAxisWidth-padding.bottom})`); // é»˜è®¤æ˜¾ç¤ºåœ¨ä¸Šæ–¹æ˜¾ç¤ºï¼Œè¦ä½¿ä»–åç§»åˆ°ä¸‹é¢
gy.call(yAxis);
```
## ç”¨æˆ·äº¤äº’ä¸åŠ›å¯¼å‘å›¾
### äº¤äº’å¼æ“ä½œ
#### ç®€ä»‹

ç”¨æˆ·äº¤äº’æŒ‡çš„æ˜¯**ç”¨æˆ·è¾“å…¥äº†æŸç§æŒ‡ä»¤ï¼Œç¨‹åºæ¥æ”¶åˆ°ååšå‡ºäº†æŸç§å“åº”**ï¼Œè€Œ D3.js ä¸­çš„ç”¨æˆ·äº¤äº’å½“ç„¶æŒ‡çš„æ˜¯ç”¨æˆ·ä¸å¯è§†åŒ–å›¾è¡¨çš„äº¤äº’æ“ä½œäº†ã€‚

ä¾‹å¦‚é¼ æ ‡ç§»åŠ¨è‡³å›¾å½¢ä¸Šæ—¶å€™å›¾å½¢çš„å˜è‰²ã€å˜å½¢ã€æ–‡å­—æç¤ºï¼Œæˆ–æ˜¯ç‚¹å‡»å˜å¤§ç¼©å°ç­‰ç­‰ï¼Œè€Œæœ€ç»å…¸çš„è¿ç”¨å°±æ˜¯..åŠ›å¯¼å‘å›¾..äº†ã€‚

- [å‰å®³çš„äº¤äº’å¼å›¾è¡¨æ¡ˆä¾‹](http://www.a4z.cn/pui/ant-admin.html#/vertical-bp-chart)

#### æ·»åŠ äº¤äº’

D3 ä¸­ä½¿ç”¨äº‹ä»¶ç›‘å¬å‡½æ•°`.on(type, function)`ä¸ºå…ƒç´ æ·»åŠ äº¤äº’äº‹ä»¶ã€‚

- å‚æ•° type ä¸ºäº‹ä»¶ç±»å‹ï¼Œä¸‹è¡¨ä¸ºå¸¸è§çš„äº‹ä»¶ï¼Œå‚æ•° function ä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
	
	|äº‹ä»¶å|å«ä¹‰|
	|---|---|
	|**é¼ æ ‡æ“ä½œ**||
	|click|é¼ æ ‡å•å‡»|
	|mouseover|é¼ æ ‡è¿›å…¥|
	|mouseout|é¼ æ ‡ç§»å‡º|
	|mousemove|é¼ æ ‡ç§»åŠ¨(éœ€èŠ‚æµå¤„ç†)|
	|mousedown|é¼ æ ‡æŒ‰ä¸‹|
	|mouseup|é¼ æ ‡æ¾å¼€|
	|dblclick|é¼ æ ‡åŒå‡»|
	|**é”®ç›˜æ“ä½œ**|æŒ‰ä½ä¸æ”¾ä¼šæŒç»­è§¦å‘|
	|keydown|é”®ç›˜æŒ‰ä¸‹|
	|keyup|é”®ç›˜é‡Šæ”¾|
	|keypress|é”®ç›˜æŒ‰ä¸‹å­—ç¬¦é”®|
	|**è§¦å±æ“ä½œ**||
	|touchstart|è§¦æ‘¸å±å¹•|
	|touchmove|è§¦æ‘¸ç‚¹ç§»åŠ¨|
	|touchend|ç¦»å¼€å±å¹•|

- `d3.select(this)`å¯ä»¥ç›´æ¥é€‰æ‹©è§¦å‘äº‹ä»¶çš„å…ƒç´ ï¼Œä½†å‰ææ˜¯äº‹ä»¶å¤„ç†å‡½æ•°ä¸ä½¿ç”¨ç®­å¤´å‡½æ•°
	
- æ¯ä¸ª`select`çš„å…ƒç´ éƒ½å¯ä»¥æ·»åŠ `.on()`äº‹ä»¶ç›‘å¬å‡½æ•°

### å¸ƒå±€

å¸ƒå±€çš„ä½œç”¨æ˜¯å°†ä¸é€‚åˆç”¨äºç»˜å›¾çš„æ•°æ®è½¬æ¢ä¸ºé€‚åˆç”¨äºç»˜å›¾çš„æ•°æ®ï¼Œç®€è€Œè¨€ä¹‹â€”â€”**æ•°æ®è½¬æ¢**ã€‚

- D3ï¼ˆv4 ä»¥ä¸Šç‰ˆæœ¬ï¼‰æä¾›äº†ä»¥ä¸‹12ç§å¸ƒå±€ï¼š
    
    |å¸ƒå±€([v3](https://github.com/d3/d3/wiki/API--ä¸­æ–‡æ‰‹å†Œ)ä¸[v4ä»¥ä¸Š](https://github.com/tianxuzhang/d3.v4-API-Translation)ç‰ˆæœ¬å†™æ³•ä¸åŒ)|API|
	|---|---|
	|é¥¼çŠ¶å›¾(Pie)|d3.layout.pie|
	|åŠ›å¯¼å‘å›¾(Force)|d3.forceSimulation|
	|å¼¦å›¾(Chord)|d3.layout.chord|
	|æ ‘çŠ¶å›¾(Tree)|d3.tree|
	|é›†ç¾¤å›¾(Cluster)|d3.cluster|
	|æ†å›¾(Bundle)|d3.layout.bundle|
	|æ‰“åŒ…å›¾(Pack)|d3.pack|
	|ç›´æ–¹å›¾(Histogram)|d3.layout.histogram|
	|åˆ†åŒºå›¾(Partition)|d3.partition|
	|å †æ ˆå›¾(Stack)|d3.layout.stack|
	|çŸ©é˜µæ ‘å›¾(Treemap)|d3.treemap |
	|å±‚çº§å›¾(Hierarchy)|d3.hierarchy|

### åŠ›å¯¼å‘å›¾

å»ºç«‹åœ¨åŠ›å­¦æ¨¡å‹åŸºç¡€ä¸Šçš„ä¸€ç§ç‰¹æ®Šçš„å›¾è¡¨ï¼Œå¸¸ç”¨æ¥å‘ˆç°å¤æ‚çš„å…³ç³»ç½‘ç»œã€‚ç”±èŠ‚ç‚¹å’Œè¿çº¿ç»„æˆï¼ŒèŠ‚ç‚¹å’Œè¿çº¿éƒ½è¢«æ–½åŠ äº†åŠ›çš„ä½œç”¨ï¼Œæ ¹æ®åŠ›æ¥è®¡ç®—èŠ‚ç‚¹å’Œè¿çº¿çš„è¿åŠ¨è½¨è¿¹ã€‚

![draw_step.png](http://blog.xuezenghui.com/D3.js/draw_step.png "ä¸åŒå·¥å…·ç»˜åˆ¶å›¾è¡¨æ­¥éª¤")

#### æ•´ä½“æ€è·¯

1. å®šä¹‰æ•°æ®ï¼ˆèŠ‚ç‚¹æ•°æ®å’Œè¿çº¿æ•°æ®ï¼‰

2. å®šä¹‰SVGç”»å¸ƒ

3. è®¾ç½®åŠ›å¯¼å‘å›¾å¸ƒå±€

4. ç»˜åˆ¶èŠ‚ç‚¹ï¼ˆ`circle`ï¼‰ã€è¿çº¿ï¼ˆ`line`ï¼‰ã€æè¿°æ–‡å­—ï¼ˆ`text`ï¼‰å’Œå…³ç³»æ–‡å­—ï¼ˆ`text`ï¼‰

5. ç›‘å¬åŠ›å¯¼å‘å›¾çš„`tick`äº‹ä»¶ï¼Œæ¯è¿åŠ¨ä¸€å¸§é‡æ–°è®¾ç½®èŠ‚ç‚¹åæ ‡ã€è¿çº¿èµ·å§‹ç»“å°¾åæ ‡ã€æè¿°æ–‡å­—åæ ‡å’Œå…³ç³»æ–‡å­—åæ ‡


```js
const nodes = [{ name: "Zander" }, { name: "Annie" }, { name: "Anna" }, 
{ name: "Doris" }, { name: "Linda" }, { name: "Censek" }, { name: "Paul" }];

const edges = [{
        source: 0, // æ•°ç»„ä¸‹æ ‡
        target: 4,
        relation: "Cherryç»„é˜Ÿå‹"
    },
    {
        source: 0,
        target: 6,
        relation: "ä¸Šä¸‹å±"
    },
    {
        source: 1,
        target: 3,
        relation: "Aliceç»„é˜Ÿå‹"
    },
    {
        source: 1,
        target: 6,
        relation: "ä¸Šä¸‹å±"
    },
    {
        source: 2,
        target: 6,
        relation: "ä¸Šä¸‹å±"
    },
    {
        source: 2,
        target: 5,
        relation: "ä¸¤å£å­"
    },
    {
        source: 3,
        target: 6,
        relation: "ä¸Šä¸‹å±"
    },
    {
        source: 4,
        target: 6,
        relation: "ä¸Šä¸‹å±"
    },
    {
        source: 5,
        target: 6,
        relation: "ä¸Šä¸‹å±"
    },
    {
        source: 2,
        target: 4,
        relation: "ç›¸çˆ±ç›¸æ€"
    },
    {
        source: 3,
        target: 5,
        relation: "å®¤å‹"
    }
];
const height = 800;
const width = 800;
const padding = {
    top: 50,
    left: 50,
    bottom: 50,
    right: 50
};
// svgç”»å¸ƒ
let svg = d3
    .select("#svg")
    .append("svg")
    .attr("height", height)
    .attr("width", width);
// è®¾ç½®åŠ›å¯¼å‘å›¾å¸ƒå±€å’Œå‚æ•°
let force = d3
    .forceSimulation() // æŒ‡å®šä¸ºåŠ›å¯¼å‘å›¾å¸ƒå±€
    .nodes(nodes) // è®¾ç½®èŠ‚ç‚¹
    .force("link", d3.forceLink(edges).distance(200)) // è®¾ç½®è¿çº¿å’Œè¿çº¿çš„é•¿åº¦
    .force("charge", d3.forceManyBody) // æ·»åŠ å¤šä½“åŠ›ï¼ˆå¸åŠ›ã€æ–¥åŠ›ç­‰ç»„åˆèµ·æ¥çš„é«˜é˜¶å‡½æ•°ï¼‰
    .force(
        "center", // è®¾ç½®åŠ›ä¸­å¿ƒç‚¹
        d3
        .forceCenter() // åˆ›å»ºä¸€ä¸ªåŠ›ä¸­å¿ƒ
        .x((width - padding.left - padding.right) / 2) // xåæ ‡
        .y((height - padding.top - padding.bottom) / 2) // yåæ ‡
    );
console.log(nodes); // æ•°æ®æ”¹å˜
// ç»˜åˆ¶èŠ‚ç‚¹
var circles = svg
    .selectAll("circle")
    .data(nodes)
    .enter()
    .append("circle")
    .attr("r", 10)
    .style("fill", "yellow");
// ç»˜åˆ¶è¿çº¿
var lines = svg
    .selectAll("line")
    .data(edges)
    .enter()
    .append("line")
    .style("stroke", "green")
    .style("stroke-width", 1);
// æ·»åŠ æè¿°
var text = svg
    .selectAll("text")
    .data(nodes)
    .enter()
    .append("text")
    .style("font-size", "12px")
    .style("fill", "#000")
    .attr("dx", 0)
    .attr("dy", 0)
    .text(d => d.name);
// æ·»åŠ å…³ç³»
var relations = svg
    .selectAll(".relation")
    .data(edges)
    .enter()
    .append("text")
    .style("fill", "red")
    .style("font-size", "11px")
    .attr("class", "relation")
    .attr("dx", 0)
    .attr("dy", 0)
    .text(d => d.relation);
force.on("tick", () => { // ç›‘å¬åŠ›å¯¼å‘å›¾æ¯è¿åŠ¨ä¸€å¸§
    lines
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);
    circles
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .call( // å°†æ‹–æ‹½è¡Œä¸ºåŠ å…¥åˆ°èŠ‚ç‚¹ä¸Š
            d3
            .drag() // è®¾ç½®æ‹–æ‹½è¡Œä¸º
            .on("start", dragStarted) // æ‹–æ‹½å¼€å§‹
            .on("drag", dragging) // æ‹–æ‹½ä¸­
            .on("end", dragEnded) //æ‹–æ‹½ç»“æŸ
        );
    text.attr("x", d => d.x).attr("y", d => d.y);
    relations
        .attr("x", d => (d.source.x + d.target.x) / 2) // xåæ ‡ä¸ºè¿çº¿ä¸­é—´ç‚¹xåæ ‡
        .attr("y", d => (d.source.y + d.target.y) / 2); // yåæ ‡ä¸ºè¿çº¿ä¸­é—´ç‚¹yåæ ‡
});
function dragStarted(d) { // æ‹–æ‹½å¼€å§‹äº‹ä»¶å¤„ç†å‡½æ•°
    if (!d3.event.active) force.alphaTarget(0.3).restart(); // è®¾ç½®åŠ›çš„è¡°å‡ç³»æ•°Î±ï¼ˆèŒƒå›´[0, 1]ï¼Œå€¼è¶Šå¤§ç§»åŠ¨é€Ÿåº¦è¶Šé«˜ï¼Œå¹¶é‡æ–°å¸ƒå±€è¯¥åŒºåŸŸ
    d.fx = d.x; // d.fxä¸ºé™æ­¢æ—¶çš„åæ ‡ï¼Œd.xä¸ºåˆå§‹åæ ‡
}
function dragging(d) { // æ‹–æ‹½ä¸­äº‹ä»¶å¤„ç†å‡½æ•°
    d.fx = d3.event.x; // d3.event.xä¸ºæ‹–åŠ¨æ—¶çš„åæ ‡
    d.fy = d3.event.y;
}
function dragEnded(d) { // æ‹–æ‹½ç»“æŸäº‹ä»¶å¤„ç†å‡½æ•°
    if (!d3.event.active) force.alphaTarget(0);
    d.fx = null;
    d.fy = null;
}
}
```
![force_result.gif](http://blog.xuezenghui.com/D3.js/force_result.gif "æ•ˆæœ")

## æ²¡äº‹å„¿ç”»å•¥åœ°å›¾ï¼Ÿ
- æ¯”å¦‚ç°æœ‰ä¸€éœ€æ±‚ï¼š
	- åœ¨åƒé¸¡åœ°å›¾ä¸­æ ‡ç¤ºå‡ºå“ªé‡Œè·³ä¼çš„äººå¤šåŠå“ªé‡Œè·³ä¼çš„äººå°‘ï¼Œç„¶åå°±å¯ä»¥æ ¹æ®è¿™ä¸ªå›¾å¤§æ¦‚åˆ†æå‡ºè·³å“ªé‡Œè½åœ°æˆç›’çš„å‡ ç‡æ›´å°ğŸŒšã€‚

![hot_map.jpeg](http://blog.xuezenghui.com/D3.js/hot_map.jpeg "æŸæ‰‹æ¸¸çƒ­åŠ›å›¾")

- æ­£ç»ç‚¹å„¿ï¼Œå®é™…ä¸šåŠ¡éœ€æ±‚ï¼š
	- åœ¨ä¸­å›½åœ°å›¾ä¸Šæ˜¾ç¤ºå‡ºç™¾æ˜Ÿ23ä¸ªè‡ªæœ‰åˆ¶ä½œä¸­å¿ƒã€16ä¸ªé©»åœºåˆ¶ä½œä¸­å¿ƒã€39ä¸ªå¤–åŒ…æœåŠ¡ç«™ç‚¹æ‰€åœ¨çš„åœ°ç†ä½ç½®(å®åŠ›æ‰“å¹¿å‘ŠğŸ¤¨)ï¼Œå¹¶é€šè¿‡ç‚¹çš„å¤§å°ã€äº®åº¦ç­‰ä½“ç°å‡ºä¸åŒåˆ¶ä½œä¸­å¿ƒçš„ä¸šåŠ¡é‡é«˜ä½ã€‚

- æ²¡é”™ï¼Œ**çƒ­ç‚¹å›¾**(åˆç§°åœ°å›¾æ•£ç‚¹å›¾)æ˜¯è¿™ç±»éœ€æ±‚çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆï¼Œå…¶å¯é€šè¿‡åœ¨åœ°å›¾ä¸Šä¸åŒåŒºåŸŸä½¿ç”¨ä¸åŒçš„æ ‡å¿—æ¥å‘ˆç°ä¸åŒåŒºåŸŸçš„å…³æ³¨ç¨‹åº¦ï¼Œä½¿æ•°æ®æ¸…æ™°æ˜äº†åœ°å‘ˆç°åœ¨äººçœ¼å‰ã€‚

## ç»˜åˆ¶çƒ­ç‚¹å›¾

### å‡†å¤‡å·¥ä½œ

#### ä¸­å›½åœ°ç†ä¿¡æ¯æ–‡ä»¶â€”â€”[GeoJSON](https://www.oschina.net/translate/geojson-spec)

GeoJSONæ˜¯ç”¨äºæè¿°åœ°ç†ç©ºé—´ä¿¡æ¯çš„æ•°æ®æ ¼å¼ï¼ŒåŒ…æ‹¬åœ°å›¾ä¸Šçš„æ‰€æœ‰è¦ç´ ï¼Œå¦‚ç»çº¬åº¦ã€ç‚¹ã€çº¿ã€é¢ã€ç‰¹å¾ç­‰ï¼Œæ ¼å¼ä¸º JSON æ ¼å¼ã€‚

> ç½‘ä¸Šæœç´¢ china.json ä¸€å¤§å †ğŸ˜ï¼Œä½†æ˜¯è¦æ³¨æ„æ ¼å¼è¦ç¬¦åˆ GeoJSON æ ‡å‡†

#### çƒå½¢â¡ï¸å¹³é¢æŠ•å½±â€”â€”`d3-geo`

ç»çº¬åº¦ä¸èƒ½ç›´æ¥ç”¨äºç»˜å›¾ï¼Œéœ€è¦è½¬æ¢ä¸ºå¹³é¢åæ ‡ï¼ŒD3 ä¸­æä¾›äº†ä¸°å¯Œçš„[æŠ•å½±å‡½æ•°](https://github.com/d3/d3/wiki/API--%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C#user-content-d3geo-%E5%9C%B0%E7%90%86)æ¥å¤„ç†çƒé¢åæ ‡å’Œç»çº¬åº¦è¿ç®—ã€‚

å®‰è£…ï¼š`npm install d3-geo d3-array --save`

#### é…è‰²æ–¹æ¡ˆ

å®‰è£…ï¼š`npm install d3-scale-chromatic --save`

### ç»˜åˆ¶åœ°å›¾

#### æŒ‰éœ€å¯¼å…¥ç±»åº“

```html
<!-- HTMLç»“æ„ -->
<div>
  <div id="svg"></div>
  <div id="hover"></div>
</div>
```

```js
// .vueæ–‡ä»¶ä¸­
import * as geo from "d3-geo";
import * as d3Color from "d3-scale-chromatic";
```

#### å®šä¹‰ SVG ç”»å¸ƒå’ŒæŠ•å½±å‡½æ•°

```js
// æŠ•å½±å‡½æ•°
const projection = geo
    .geoMercator() // çƒå½¢å¢¨å¡æ‰˜æŠ•å½±
    .scale(550) // æŠ•å½±çš„æ¯”ä¾‹å› å­ï¼Œå¯æŒ‰æ¯”ä¾‹æ”¾å¤§æŠ•å½±
    .center([105, 38]) // è®¾ç½®ä¸­å¿ƒç‚¹çš„ç»çº¬åº¦ä¸ºä¸­å›½åœ°å›¾ä¸­å¿ƒç‚¹
    .translate([width / 2, height / 2]); // å°†æŠ•å½±åç§»è‡³è®¾SVGä¸­å¿ƒ
```

#### åˆ›å»ºè·¯å¾„ç”Ÿæˆå™¨å’Œé¢œè‰²æ¯”ä¾‹å°º

```js
const path = geo.geoPath(projection);
const colors = d3.scaleOrdinal(d3Color.schemeBrBG[11]); 
```
#### è·å– GeoJSON æ•°æ®ï¼Œç”Ÿæˆåœ°å›¾

æ­¤å¤„ä¸ºé‡ä¸­ä¹‹é‡ï¼Œè¦ä½¿ç”¨ D3.js æä¾›çš„`d3.json()`æ–¹æ³•è·å–åœ°ç†ä¿¡æ¯æ–‡ä»¶ï¼Œ[å®˜æ–¹æ–‡æ¡£](https://github.com/d3/d3/wiki/%E8%AF%B7%E6%B1%82#d3_json)è¡¨æ˜æ­¤æ–¹æ³•**æ ¹æ®æŒ‡å®šçš„urlåˆ›å»ºä¸€ä¸ªJSONæ–‡ä»¶è¯·æ±‚**ï¼Œè¿™å°±è¦æ±‚ä¸èƒ½ä½¿ç”¨æœ¬åœ°çš„ JSON æ–‡ä»¶è€Œè¦æ­å»ºæœåŠ¡å™¨è¿”å›æ•°æ®ã€‚æœ¬æ¡ˆä¾‹ä½¿ç”¨ Express + MongoDB æ­å»ºäº†ç®€å•çš„æœåŠ¡å™¨è¿”å›åœ°ç†ä¿¡æ¯æ•°æ®ã€‚

```js
async function getJson() { // ä½¿ç”¨d3.json()æ–¹æ³•æ‹¿åˆ°GeoJSONæ•°æ®
    const result = await d3.json("/api/allData");
    // const result = await d3.json("../../static/china.json"); // d3.json()ä¸å¯è®¿é—®æœ¬åœ°æ–‡ä»¶
    const data = result.result; // æ‹¿åˆ°æ•°æ®ï¼ŒObjectç±»å‹
    console.log(data);
    return data;
}
getJson().then(data => {
    svg
        .selectAll("path")
        .data(data.features) // ç»‘å®šåœ°ç†ç‰¹å¾æ•°æ®
        .enter()
        // .append("path")
        .insert("path", "g")
        .attr("d", path)
        .attr("fill", function (d, i) { // åŠ å…¥é¢œè‰²æ¯”ä¾‹å°º
            return colors(i);
        })
        .attr("stroke", "rgba(255, 255, 255, 1")
        .attr("stroke-width", 1);
});
```

> ä½¿ç”¨`append("path")`çš„è¯ DOM ç»“æ„ä¸­ path å…ƒç´ ä¼šå¤„äº g å…ƒç´ ä¹‹å‰ï¼Œå¯¼è‡´ path è¦†ç›– g å…ƒç´ ï¼ŒåŸå› æ˜¯ D3 ä¸­å…ƒç´ çš„å±‚çº§æ˜¯ç”±å…ƒç´ åˆ›å»ºçš„å…ˆåé¡ºåºæ¥å†³å®šçš„ã€‚

### å®šä½åŸå¸‚åæ ‡

#### å®šä¹‰åŸå¸‚åæ ‡æ•°æ®

```js
const places = [
  { name: "åŒ—äº¬åˆ¶ä½œä¸­å¿ƒ", log: "116.54", lat: "39.82" }, // logä¸ºç»åº¦ï¼Œ latä¸ºçº¬åº¦
  { name: "è¥¿å®‰åˆ¶ä½œä¸­å¿ƒ", log: "108.84", lat: "34.21" },
  { name: "æ²ˆé˜³åˆ¶ä½œä¸­å¿ƒ", log: "123.39", lat: "41.86" }
];
```

#### æ ‡ç‚¹å¹¶ç»˜åˆ¶

```js
const location = svg
    .selectAll("g")
    .data(places)
    .enter()
    .append("g")
    .attr("transform", d => {
        const coord = projection([d.log, d.lat]); // å°†ç»çº¬åº¦è½¬åŒ–ä¸ºé¡µé¢åæ ‡
        console.log("coord", coord);
        return `translate(${coord[0]},${coord[1]})`;
    });
location
    .append("circle")
    .attr("r", 4)
    .attr("fill", "yellow");
```
#### åŠ å…¥åŠ¨ç”»

```js
const hover = d3.select("#hover");
location
    .on("mouseover", function (d) {
        hover
            .html(d.name)
            .style("position", "fixed")
            .style("color", "blue")
            .style("left", d3.event.pageX - 45 + "px")
            .style("top", d3.event.pageY - 40 + "px")
            .style("opacity", 1);

        d3.select(this)
            .select("circle")
            .transition()
            .duration(500)
            .attr("r", 8);
    })
    .on("mouseout", function () {
        hover.style("opacity", 0);
        d3.select(this)
            .select("circle")
            .transition()
            .duration(1000)
            .attr("r", 4);
    });
```

![china_map.gif](http://blog.xuezenghui.com/D3.js/china_map.gif "ç™¾æ˜Ÿåˆ¶ä½œä¸­å¿ƒçƒ­ç‚¹å›¾")

***

ğŸ±æ¡ˆä¾‹ GitHub åœ°å€ï¼š[https://github.com/Xuezenghuigithub/D3.js_china_map](https://github.com/Xuezenghuigithub/D3.js_china_map)
## ğŸ§­æŒ‡å—ï¼š
- [D3.js å®˜æ–¹ä¸­æ–‡æ–‡æ¡£](https://github.com/d3/d3/wiki/CN-Home)

- [D3.js åœ¨çº¿ç»˜å›¾å·¥å…·](https://blockbuilder.org/)

- [æ¯”ä¾‹å°ºè¯¦è§£](https://segmentfault.com/a/1190000011006780)

- [æå®¢å­¦é™¢ D3.js æ•™ç¨‹](http://wiki.jikexueyuan.com/project/d3wiki/scale.html)