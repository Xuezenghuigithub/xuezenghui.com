---
title: "å›¾ç‰‡é¢„è§ˆ"
date: "2020-04-22T09:04:15+08:00"
tags: ["JavaScript"]
keywords: ["å›¾ç‰‡é¢„è§ˆ", "FileReader"]
categories: ["Tech"]
slug: "preview-image"
dropCap: false
---
## éœ€æ±‚
ä»Šå¤©æ¥çœ‹ä¸€ä¸ªæŒºå¸¸è§çš„éœ€æ±‚ï¼Œä¸Šä¼ å›¾ç‰‡æ—¶é¡µé¢å±•ç¤ºé€‰æ‹©çš„å›¾ç‰‡ï¼Œå…·ä½“å®ç°æ•ˆæœå¯ä»¥ç‚¹å‡»ä¸‹é¢çš„ã€Œä¸Šä¼ å›¾ç‰‡ã€æŒ‰é’®è¯•è¯•ğŸ‘‡ï½ï¼ˆåªèƒ½é€‰æ‹© .png æˆ– .jpeg æ ¼å¼å›¾ç‰‡ï¼‰

> æŒ‰é’®è®¾è®¡æºè‡ª [CodePen](https://codepen.io/sfoxy/pen/XpOoJe)ã€‚

<style>
@import url('https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap');

.btn {
  width: 180px;
  height: 45px;
  border: none;
  display: block;
  text-align: center;
  text-transform: uppercase;
  outline: none;
  overflow: hidden;
  position: relative;
  color: #fff;
  font-family: 'Zhi Mang Xing', cursive;
  font-size: 30px;
  background-color: #222;
  margin: 0 auto;
  box-shadow: 0 5px 15px rgba(0,0,0,0.20);
}

.btn label {
  display: block;
  width: 100%;
  height: 100%;
  position: relative; 
  z-index: 1;
  line-height: 45px;
  cursor: pointer;
}

.btn:after {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  height: 490%;
  width: 140%;
  background: #78c7d2;
  -webkit-transition: all .5s ease-in-out;
  transition: all .5s ease-in-out;
  -webkit-transform: translateX(-98%) translateY(-25%) rotate(45deg);
  transform: translateX(-98%) translateY(-25%) rotate(45deg);
}

.btn:hover:after {
  -webkit-transform: translateX(-9%) translateY(-25%) rotate(45deg);
  transform: translateX(-9%) translateY(-25%) rotate(45deg);
}

.my_input {
  display: none;
}
</style>


<input type="file" class="my_input" id="inputFile" accept="image/png, image/jpeg">
<button class="btn"><label for="inputFile">ä¸Šä¼ å›¾ç‰‡</label></button>
<img id="previewImg" />

<script>
document.getElementById('inputFile').addEventListener('change', handleChange, false);
function handleChange(e) {
  let fileList = e.target.files;
  if (fileList[0].type !== 'image/png' && fileList[0].type !== 'image/jpeg') return;
  /* æ–¹å¼ä¸€ã€FileReader */
  const reader = new FileReader(); // å®ä¾‹åŒ–å¯¹è±¡
  reader.readAsDataURL(fileList[0]); // å¼€å§‹å¼‚æ­¥è¯»å–æ–‡ä»¶
  reader.onload = function (e) { // è¯»å–å®Œæ–‡ä»¶åè§¦å‘çš„å‡½æ•°
    document.getElementById('previewImg').src = e.target.result; // å°†å›¾ç‰‡çš„ base64 ç¼–ç èµ‹å€¼ç»™å®¹å™¨çš„ src å±æ€§
  }
  /* æ–¹å¼äºŒã€å¯¹è±¡ URL */
  // document.getElementById('previewImg').src = (URL || webkitURL).createObjectURL(fileList[0]);
  // (URL || webkitURL).revokeObjectURL(fileList[0]); // é‡Šæ”¾å†…å­˜
}
</script>

## å®ç°
### HTML
é¦–å…ˆæ˜¯è¦ä½¿ç”¨çš„æ ‡ç­¾ï¼Œä¸Šä¼ æ–‡ä»¶éœ€è¦ç”¨åˆ° `<input>` æ ‡ç­¾ï¼Œå¹¶ä¸”æŒ‡å®šå±æ€§ `type` çš„å€¼ä¸º `file`ã€‚

æ—¢ç„¶æ˜¯é¢„è§ˆå›¾ç‰‡ï¼Œé‚£ä¹ˆè¿˜éœ€è¦æŒ‡å®šé€‰æ‹©æ–‡ä»¶çš„ç±»å‹ï¼Œä½¿ç”¨ `accept` å±æ€§å¯ä»¥è§„å®š..æœŸæœ›..çš„æ–‡ä»¶ç±»å‹ï¼Œä¸ºå•¥æ˜¯ã€ŒæœŸæœ›ã€å‘¢ï¼Ÿå› ä¸ºè¿™åªè¡¨ç¤ºè§¦å‘æ§ä»¶åé»˜è®¤å…è®¸é€‰ä¸­çš„æ–‡ä»¶ç±»å‹ï¼Œæ¯”å¦‚åœ¨ MacOS ä¸Šï¼Œåˆé’»çš„ç”¨æˆ·ä»å¯ä»¥åœ¨å”¤å‡ºçš„é€‰æ‹©æ–‡ä»¶çª—å£ä¸­é€šè¿‡`é€‰é¡¹`â¡ï¸`æ ¼å¼ï¼šæ‰€æœ‰æ–‡ä»¶`æ¥é€‰æ‹©å…¶å®ƒç±»å‹çš„æ–‡ä»¶ä¸Šä¼ ğŸ‘¿ï¼š

![choose-file.png](/images/preview-image:choose-file.png "ä»å¯é€‰æ‹©éæŒ‡å®šç±»å‹çš„æ–‡ä»¶")

è¿™å°±è¦æ±‚åœ¨ JavaScript ä¸­è¿˜è¦åˆ¤æ–­ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶ç±»å‹æ˜¯å¦åˆæ³•ï¼Œåé¢ä¼šè¯´åˆ°ï¼Œå…ˆæŒ‡å®šæœŸæœ›çš„ç±»å‹ä¸º PNG æˆ– JPG æ ¼å¼çš„å›¾ç‰‡ã€‚å¹¶ä¸”ï¼Œä½¿ç”¨ `<input>` æ ‡ç­¾æ—¶å¸¸ç”¨çš„åšæ³•æ˜¯ä¸ `<label>` æ ‡ç­¾åˆç”¨å¹¶ä¸”è®¾ç½® `<input>` ä¸ºä¸å¯è§ï¼Œè¿™æ ·åšçš„å¥½å¤„æœ‰ä¸¤ç‚¹ï¼š

1. `<input>` çš„æ ·å¼ä¸æ˜“è°ƒæ•´ï¼Œè€Œ `<label>` çš„æ ·å¼å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºã€‚
2. `<label>` å¢åŠ äº† `<input>`çš„å‘½ä¸­åŒºåŸŸã€‚

æ‰€ä»¥ç°åœ¨çš„ HTML æ˜¯è¿™æ ·çš„ï¼š

```html
<input type="file" accept="image/png, image/jpg" id="inputFile">
<label for="inputFile">ä¸Šä¼ å›¾ç‰‡</label>
```

### CSS
æ ·å¼ä¸Šè¦åšçš„ä¸€ç‚¹æ˜¯éšè— `<input>`ï¼Œå‰©ä¸‹çš„å°±å®Œå…¨è‡ªç”±åŒ–äº†ï¼š

```css
input {
  display: none;
}
```

å¦å¤–ï¼Œ[CodePen](https://codepen.io) ä¸Šçš„å„ç§æŒ‰é’®æ ·å¼å¯çœŸæ˜¯ç¾å“­æˆ‘äº†ï¼Œæ¯”é‚£äº›åœ¨çº¿è®¾è®¡æŒ‰é’®æ ·å¼çš„ç½‘ç«™å¥½å¤ªå¤šäº†ğŸ¤«ï¼Œå¼ºçƒˆå®‰åˆ©ã€‚
### JavaScript
åˆ°äº†åŠŸèƒ½å®ç°çš„ç¯èŠ‚äº†ï¼Œé¦–å…ˆéœ€è¦æ‹¿åˆ°é€‰æ‹©å›¾ç‰‡çš„ç›¸å…³ä¿¡æ¯ï¼Œåœ¨ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶æ—¶å¯ä»¥è§¦å‘ `<input>` çš„ `change` äº‹ä»¶ï¼Œ`change` äº‹ä»¶çš„å‚æ•°å†…åŒ…å«ä¸€ä¸ªå±æ€§ `files`ï¼Œå…¶å¯¹åº”çš„å€¼ [`FileList`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileList) æ˜¯ä¸€ä¸ª..ç±»æ•°ç»„..ï¼Œç”±ä¸€ä¸ªä¸ª [`File`](https://developer.mozilla.org/zh-CN/docs/Web/API/File) å¯¹è±¡ç»„æˆï¼Œå¯¹è±¡å†…å­˜å‚¨ç€ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ã€å¤§å°ã€ç±»å‹ç­‰ã€‚

> å› ä¸º `<input>` æœ‰ä¸€ä¸ª `multiple` å±æ€§ï¼Œè®¾ç½®åå¯ä»¥é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥ `FileList` çš„ç±»å‹ä¸ºç±»æ•°ç»„ã€‚

èƒ½è·å–åˆ°æ–‡ä»¶çš„ç±»å‹å°±å¯ä»¥åšæˆ‘ä»¬ä¸Šé¢è¯´çš„**æ ¡éªŒæ–‡ä»¶åˆæ³•æ€§**äº†ï¼š

```js
document.getElementById('inputFile').addEventListener('change', handleChange, false);

function handleChange(e){
  const fileList = e.target.files; // æ–‡ä»¶å¯¹è±¡ç±»æ•°ç»„
  if(fileList[0].type !== 'image/png' && fileList[0].type !== 'image/jpeg'){ // æ ¡éªŒæ–‡ä»¶ç±»å‹
      return console.log('æ–‡ä»¶ç±»å‹é”™è¯¯');
  }
}
```
æ¥ä¸‹æ¥éœ€è¦åœ¨é¡µé¢ä¸­æ˜¾ç¤ºå›¾ç‰‡ï¼Œéœ€è¦ä¸€ä¸ªå±•ç¤ºå›¾ç‰‡çš„å®¹å™¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ JavaScript ç›´æ¥æ’å…¥åˆ°é¡µé¢ï¼Œä½†å‰è€…æ›´å®¹æ˜“è®¾ç½®å›¾ç‰‡çš„æ ·å¼ã€‚æ˜¾ç¤ºå›¾ç‰‡æœ‰ä¸¤ç§æ–¹å¼â€”â€”**FileReader** å’Œ**å¯¹è±¡ URL**ã€‚

**1. FileReader**

[FileReader](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader) å¯¹è±¡ç”¨æ¥..å¼‚æ­¥..è¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œå¯è¯»å–çš„ç›®æ ‡æ­£æ˜¯è·å–åˆ°çš„ File å¯¹è±¡ã€‚

```js
const reader = new FileReader(); // å®ä¾‹åŒ–å¯¹è±¡
reader.readAsDataURL(fileList[0]); // å¼€å§‹å¼‚æ­¥è¯»å–æ–‡ä»¶
reader.onload = function (e) { // è¯»å–å®Œæ–‡ä»¶åè§¦å‘çš„å‡½æ•°
  document.getElementById('previewImg').src = e.target.result; // å°†å›¾ç‰‡çš„ base64 ç¼–ç èµ‹å€¼ç»™å®¹å™¨çš„ src å±æ€§
}
```

[`readAsDataURL()`](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader/readAsDataURL) æ–¹æ³•å¯è¯»å–ä¼ å…¥çš„ File å¯¹è±¡ï¼Œè¯»å–å®Œæˆåä¼šè§¦å‘ `onload` äº‹ä»¶ï¼Œäº‹ä»¶çš„å‚æ•°ä¸­å°±åŒ…å«**å›¾ç‰‡çš„ base64 ç¼–ç **ï¼Œç„¶åå°†å®ƒè®¾ç½®ä¸ºé¡µé¢ä¸­ç”¨äºå±•ç¤ºå›¾ç‰‡çš„ `<img>` æ ‡ç­¾çš„ `src` å±æ€§ï¼Œå›¾ç‰‡æˆåŠŸæ˜¾ç¤ºï½

**2. å¯¹è±¡ URL**

å¯¹è±¡ URL æŒ‡çš„æ˜¯ [`window.URL.createObjectURL()`](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL) å’Œ [`window.URL.revokeObjectURL()`](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/revokeObjectURL) æ–¹æ³•ï¼Œ`window.URL.createObjectURL()` æ–¹æ³•åŒæ ·å¯ä¼ å…¥ä¸€ä¸ª File å¯¹è±¡ï¼Œä½†æ˜¯è¿”å›çš„å¹¶ä¸æ˜¯å›¾ç‰‡çš„ base64 ç¼–ç ï¼Œè€Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—ç¬¦ä¸²[^1]ï¼Œé•¿è¿™ä¸ªäºšå­ï¼š

```
blob:null/1a92aff8-90a4-4421-966c-4b151078da0f
```

ä¸ç®¡å®ƒå«å•¥ï¼Œå®ƒåªèƒ½ç”±æµè§ˆå™¨å†…éƒ¨ç”Ÿæˆï¼Œå°† `<img>` æ ‡ç­¾çš„ `src` å±æ€§è®¾ç½®æˆå®ƒä¹Ÿå¯ä»¥æ˜¾ç¤ºå›¾ç‰‡ï¼š

```js
document.getElementById('previewImg').src = (URL || webkitURL).createObjectURL(fileList[0]);
```

> `(URL || webkitURL).createObjectURL()` ä¸ºå…¼å®¹å†™æ³•ã€‚

## ç»“è¯­
æ•ˆæœå°±ä¸ç”¨å†å±•ç¤ºäº†ï¼Œå®Œæ•´æ–¹æ³•å’Œä¸Šé¢ç‚«é…·æŒ‰é’®çš„æ¡ˆä¾‹æºç éƒ½åœ¨æˆ‘çš„ [GitHub](https://raw.githubusercontent.com/Xuezenghuigithub/xuezenghui.com/master/content/posts/%E5%9B%BE%E7%89%87%E9%A2%84%E8%A7%88.md) ä¸­ã€‚é‚£ä¹ˆåˆ°åº•è¦é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ–¹å¼å‘¢ï¼Ÿ

é¦–å…ˆï¼Œè¿™ä¸¤ä¸ª API çš„å…¼å®¹æ€§éƒ½æ˜¯å·®ä¸å¤šçš„ï¼ŒIE 10+ å’Œæ‰€æœ‰ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒã€‚ä»æ€§èƒ½ä¸Šæ¥è¯´ï¼Œ`FileReader.readAsDataURL()` æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œè€Œ `createObjectURL()` æ˜¯åŒæ­¥æ‰§è¡Œï¼Œå¹¶ä¸” Blob URLs å ç”¨çš„å†…å­˜æ¯” base64 æ›´å°ï¼Œæ‰€ä»¥æ€»ä½“æ¥è®² **`FileReader.readAsDataURL()` å ä¼˜**ï¼Œä½†å…¶å…³é—­æ ‡ç­¾é¡µæ—¶æ‰ä¼šé‡Šæ”¾å†…å­˜ï¼Œä½¿ç”¨çš„æ—¶å€™åº”è€ƒè™‘æ˜¯å¦è¦ç”¨ `window.URL.revokeObjectURL()` æ–¹æ³•æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚

## References & Resources
1. [åœ¨ web åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ–‡ä»¶ | MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/File/Using_files_from_web_applications)
2. [Preview an image before it is uploaded | Stack Overflow](https://stackoverflow.com/questions/4459379/preview-an-image-before-it-is-uploaded)
3. [What is a blob URL and why it is used? | Stack Overflow](https://stackoverflow.com/questions/30864573/what-is-a-blob-url-and-why-it-is-used)

[^1]: W3C ç§°å®ƒä¸º [Blob URLs](https://w3c.github.io/FileAPI/#blob-section)ï¼ŒMDN ç§°å®ƒä¸º [Object-URLs](https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL#Parameters)ã€‚