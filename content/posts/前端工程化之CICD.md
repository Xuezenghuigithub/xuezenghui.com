---
title: "å‰ç«¯å·¥ç¨‹åŒ–ä¹‹ CI/CD"
description: "GitLab CI/CD å®è·µ"
date: "2020-11-17T15:20:01+08:00"
tags: ["GitLab", "å‰ç«¯å·¥ç¨‹åŒ–", "CI/CD"]
keywords: ["GitLab", "CI/CD", "å‰ç«¯å·¥ç¨‹åŒ–"]
categories: ["Tech"]
slug: "gitlab-ci-cd"
gitinfo: true
comments: true
toc: true
---

åœ¨é¡¹ç›®å¼€å±•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»å¸¸åšåŠŸèƒ½åˆ†æ”¯-æµ‹è¯•åˆ†æ”¯-éƒ¨ç½²åˆ†æ”¯ä¹‹é—´çš„ä»£ç åˆå¹¶å·¥ä½œï¼Œè™½ç„¶è¯´æˆ‘ä»¬å›¢é˜Ÿæœ‰ç€åˆç†çš„ Git Flowã€Commit è§„èŒƒï¼Œä½†ç¡®ä¿ä¸äº†æ¯ä¸ªå¼€å‘äººå‘˜åœ¨æ¯æ¬¡æäº¤çš„æ—¶å€™éƒ½ä¸¥æ ¼éµå®ˆï¼Œä¸”åœ¨åˆ†æ”¯å¤æ‚ã€æäº¤æ—¶é—´èŠ‚ç‚¹ä¸ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œåˆå¹¶åˆ†æ”¯æ—¶äº§ç”Ÿå†²çªã€å¤„ç†å†²çªä¼¼ä¹æˆäº†ä¸å¯é¿å…çš„äº‹ï¼Œä»å¼€å‘çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ¥çœ‹å¯¹äº§å‡ºæ•ˆç‡çš„å½±å“æ˜¯ä¸å°çš„ã€‚

ã€Œå·¥ç¨‹åŒ–ã€è¿˜è¦è€ƒé‡çš„ä¸€ä¸ªè§’åº¦ä¾¿æ˜¯..ç”Ÿäº§æ•ˆç‡..ï¼Œä¹Ÿå°±æ˜¯ã€Œè‡ªåŠ¨åŒ–ã€ï¼Œä»»ä½•é‡å¤æ¬¡æ•°å¤šäºä¸¤æ¬¡çš„ç®€å•æœºæ¢°åŠ³åŠ¨éƒ½åº”è¯¥äº¤ç»™æœºå™¨æ¥å®Œæˆï¼Œè¿™ä¹Ÿå°±æ˜¯å‰ç«¯å·¥ç¨‹åŒ–ä¸­â€œè‡ªåŠ¨åŒ–â€çš„è¿‡ç¨‹ï¼Œå½“ç„¶ï¼Œä¸æ­¢å‰ç«¯äº†ï¼Œä»»ä½•éœ€è¦é¢‘ç¹äº¤ä»˜åº”ç”¨çš„å›¢é˜Ÿéƒ½å¸Œæœ›æœ‰ä¸€ä¸ªå·¥å…·ã€ä¸€ç§æ–¹æ³•èƒ½åº”å¯¹â€œ[é›†æˆåœ°ç‹±](https://www.solutionsiq.com/agile-glossary/integration-hell/)â€å’Œæœºæ¢°åŒ–çš„éƒ¨ç½²å·¥ä½œã€‚

## CI/CD æ¦‚è¦
### CI
Continuous Integrationï¼ŒæŒç»­é›†æˆã€‚é›†æˆè¿™ä¸ªåŠ¨ä½œæŒ‡è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­åˆå¹¶ä»£ç çš„è¿‡ç¨‹ï¼Œè€ŒæŒç»­é›†æˆæŒ‡çš„å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„è‡ªåŠ¨åŒ–çš„è¿‡ç¨‹â€”â€”åœ¨å¼€å‘äººå‘˜æäº¤æ–°ä»£ç åï¼Œè‡ªåŠ¨è¿›è¡Œæ„å»ºã€æµ‹è¯•å¹¶åˆå¹¶ä»£ç åˆ°ä»£ç ä»“åº“ä¸­ã€‚

[^1]![ci.png](/images/gitlab-ci-cd_ci.png "æŒç»­é›†æˆ")

### CD
CD æœ‰ä¸¤ç§å«ä¹‰ï¼ŒContinuous Delivery æŒç»­äº¤ä»˜å’Œ Continuous Deployment æŒç»­éƒ¨ç½²ã€‚æŒç»­äº¤ä»˜æŒ‡åœ¨å®Œæˆåº”ç”¨çš„æµ‹è¯•ã€é›†æˆå’Œæ„å»ºåå› ä¸ºå›¢é˜Ÿè¦æ±‚æˆ–ä¸šåŠ¡è¦æ±‚ï¼Œè‡ªåŠ¨å°†åº”ç”¨éƒ¨ç½²åˆ°..å‡†ç”Ÿäº§ç¯å¢ƒ..ï¼Œèƒ½éƒ¨ç½²åˆ°å‡†ç”Ÿäº§ç¯å¢ƒä¹Ÿå°±æ„å‘³ç€å¯ä»¥ç›´æ¥éƒ¨ç½²åˆ°æ­£å¼çš„ç”Ÿäº§ç¯å¢ƒï¼Œæ‰€ä»¥ï¼Œ**æŒç»­äº¤ä»˜æ„å‘³ç€ä»»ä½•çš„ä»£ç ä¿®æ”¹å¯ä»¥åœ¨ä»»ä½•æƒ³è¦éƒ¨ç½²çš„æ—¶å€™å®æ–½éƒ¨ç½²ï¼Œè¡¨ç¤ºä¸€ç§èƒ½åŠ›**ã€‚

è€Œ**æŒç»­éƒ¨ç½²åˆ™æ˜¯ä¸€ç§å®è·µï¼Œä¸€ä¸ªæœ€ç»ˆåŠ¨ä½œ**ï¼Œè¡¨ç¤ºåœ¨é€šè¿‡å‰é¢çš„æ‰€æœ‰é˜¶æ®µåè‡ªåŠ¨å°†æ”¹åŠ¨æŠ•å…¥ç”Ÿäº§ç¯å¢ƒã€‚ä¸åŒçš„å›¢é˜Ÿå¯¹æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½²æœ‰ä¸€å®šè¦æ±‚ï¼Œæ¯”å¦‚æˆ‘å¸è¦æ±‚åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå‰å…ˆéƒ¨ç½²åˆ°å‡†ç”Ÿäº§ç¯å¢ƒè¿›ä¸€æ­¥æµ‹è¯•ã€‚

![cd.png](/images/gitlab-ci-cd_cd.png "æŒç»­éƒ¨ç½²")

## GitLab CI/CD å®è·µ
CI/CD æ˜¯ GitLab çš„å†…ç½®å·¥å…·ï¼Œä¸éœ€è¦ç¬¬ä¸‰æ–¹å·¥å…·å°±å¯ä»¥æ‹¿æ¥å³ç”¨ã€‚GitLab CI/CD ä¼šæ ¹æ®ç”¨æˆ·åˆ›å»ºçš„ç‰¹å®š YAML æ–‡ä»¶ä½¿ç”¨ GitLab Runner è‡ªåŠ¨æ‰§è¡Œè„šæœ¬ï¼Œæ–‡ä»¶ä¸­çš„è„šæœ¬å³æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚æ·»åŠ ä¾èµ–é¡¹ã€æ„å»ºã€å•å…ƒæµ‹è¯•ç­‰ç­‰ã€‚

### é…ç½® GitLab Runner
å­˜æ”¾è„šæœ¬çš„ YAML æ–‡ä»¶æ˜¯å…³é”®ï¼Œä½†é¦–å…ˆéœ€è¦æœ‰æ‰§è¡Œè„šæœ¬çš„å·¥å…· [GitLab Runner](https://docs.gitlab.com/runner/)ï¼Œæ¯ä¸ªè¦å®è¡Œ CI/CD çš„é¡¹ç›®éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„ Runnerï¼ŒRunner æ˜¯ä¸€ä¸ªä½¿ç”¨ Go è¯­è¨€ç¼–å†™çš„ç±»ä¼¼ç»ˆç«¯çš„å·¥å…·ï¼Œå¯ä»¥è¿è¡Œåœ¨ Linuxã€Dockerã€maocOS ç­‰ä¼—å¤šç¯å¢ƒä¸­ï¼Œå¯ä»¥é€‰æ‹©é…ç½®ä¸‰ç§ä¸åŒç±»å‹çš„ Runnerï¼š

- **Specific Runners**ï¼šé¡¹ç›®ç‰¹å®šçš„ Runnerï¼Œé€‚ç”¨äºéœ€è¦æ‰§è¡Œéƒ¨ç½²ä½œä¸šç­‰æœ‰ç‰¹å®šè¦æ±‚çš„é¡¹ç›®
- **Shared Runners**ï¼šç”± GitLab ç®¡ç†å‘˜å®‰è£…ã€æ³¨å†Œçš„å¯ç”¨äºæ‰€æœ‰é¡¹ç›®çš„ Runner
- **Group Runners**ï¼šåŒæ ·ç”± GitLab ç®¡ç†å‘˜æ¥å®‰è£…ï¼Œä¸åŒçš„æ˜¯å¯ä»¥ç»™ç‰¹å®šçš„ Group è®¾ç½®ç‰¹å®šçš„ Runner

å› ä¸ºéœ€è¦è¿›è¡ŒæŒç»­**éƒ¨ç½²**ï¼Œéƒ¨ç½²çš„ç›®æ ‡æœåŠ¡å™¨éœ€è¦å’Œ GitLab ä¸­çš„ä»£ç ä»“åº“é€šä¿¡ï¼Œç¬¦åˆâ€œéœ€è¦æ‰§è¡Œæœ‰ç‰¹å®šè¦æ±‚çš„é¡¹ç›®â€ï¼Œå…ˆæ¥åˆ›å»ºä¸€ä¸ª Specific Runnersã€‚æ­¤å¤„ä»¥éƒ¨ç½² Vue é¡¹ç›®ä¸ºä¾‹ï¼Œåœ¨äº‘æœåŠ¡å™¨ï¼ˆUbuntu 18.04.5ï¼‰ä¸Šè¦åš..å®‰è£…..å’Œ..æ³¨å†Œ..ä¸¤ä¸ªæ­¥éª¤ï¼Œæ³¨å†Œå³å°†å®‰è£…çš„ Runner ä¸ GitLab ç»‘å®šä»¥ä½¿å…¶å¯é€šè¿‡ API é€šä¿¡ï¼š

**1. æ·»åŠ  GitLab å®˜æ–¹å­˜å‚¨åº“**

```s
$ curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
```

**2. å®‰è£… GitLab Runner**

```s
$ export GITLAB_RUNNER_DISABLE_SKEL=true; sudo -E apt-get install gitlab-runner
```

**3. è·å– URL å’Œ token**

è¿›å…¥è¦æ·»åŠ  CI/CD çš„ GitLab é¡¹ç›®çš„ `Setting` â¡ï¸ `CI/CD` é¡µé¢ï¼ˆå‰ææ˜¯ä½ è¦æœ‰è¯¥é¡¹ç›®çš„ Maintainer æƒé™ï¼‰ï¼Œå±•å¼€ Runners é¢æ¿ï¼Œåœ¨ Specific Runners æ‰¾åˆ° **GitLab URL** å’Œ **token**ã€‚

![runner-token.png](/images/gitlab-ci-cd_runner-token.png "Runner Token")

**3. æ³¨å†Œ Runner**

åœ¨ Ubuntu ä¸­è¿è¡Œ `$ sudo gitlab-runner register`ï¼ŒæŒ‰ç…§æŒ‡ä»¤ä¾æ¬¡è¾“å…¥ GitLab URLã€tokenã€æè¿°ã€æ ‡ç­¾ã€æ‰§è¡Œè€…ï¼ˆæœ¬ä¾‹è¾“å…¥ `shell`ï¼‰[^2]ã€‚

æ³¨å†Œå®Œæˆååœ¨ Runners é¢æ¿ä¸‹å³å¯çœ‹åˆ°ç»‘å®šæˆåŠŸçš„ Specific Runnerï¼š

![runner.png](/images/gitlab-ci-cd_runner.png "æ·»åŠ æˆåŠŸçš„ Runner")

> æ›´æ¢ Runner åéœ€æ‰§è¡Œ `$ sudo gitlab-runner restart` é‡å¯ä»¥ç”Ÿæ•ˆã€‚

### ç¼–å†™è„šæœ¬æ–‡ä»¶
`.gitlab-ci.yml` æ–‡ä»¶éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰‹åŠ¨åˆ›å»ºï¼Œè¿™ä¸ª YAML æ–‡ä»¶ä¸­çš„é…ç½®å«åš GitLab CI/CD çš„**ç®¡é“ Pipeline**ï¼Œæ¯å½“ä»£ç åº“æ›´æ–°æ—¶ï¼ŒGitLab éƒ½ä¼šå…ˆæŒ‰ç…§ç®¡é“ä¸­çš„å†…å®¹åœ¨ Runner ä¸Šæ‰§è¡Œç›¸åº”çš„ä½œä¸š Jobsã€‚Jobs æ˜¯ `.gitlab-ci.yml` æ–‡ä»¶ä¸­çš„æœ€åŸºæœ¬å•å…ƒï¼Œç”¨æ¥å®šä¹‰æ‰§è¡Œä¸€ä¸ªæ“ä½œçš„æ¡ä»¶å’Œä½äº `script` å­å¥å†…çš„æ“ä½œå…·ä½“å†…å®¹ï¼Œå¦‚ï¼š

```yml
stage:          # æ˜¾å¼å£°æ˜å„é˜¶æ®µï¼Œå¹¶æŒ‡å®šæ‰§è¡Œé¡ºåº
  - job1
  - ...

job1:           # è‡ªå®šä¹‰çš„ Job å
  stage: test   # å½“å‰ Job çš„é˜¶æ®µ
  script:       # ç”± Runner æ‰§è¡Œçš„ Shell è„šæœ¬
    - echo "Hello, Zander!"
```

> `stage` å¯ä»¥å†³å®šå„ä¸ª Jobs çš„æ‰§è¡Œé¡ºåºâ€”â€”åŒä¸€é˜¶æ®µçš„ Jobs å¹¶è¡Œè¿è¡Œï¼Œä¸åŒé˜¶æ®µçš„ Jobs ä¾ç…§ä¹¦å†™é¡ºåºæ‰§è¡Œï¼Œå¦‚æœå‰é¢çš„ Job å¤±è´¥ï¼Œåˆ™å°†æäº¤æ ‡è®°ä¸º `failed` å¹¶ä¸”ä¸æ‰§è¡Œåç»­çš„ Job.ã€‚ä¸æ­¢ `stage` å’Œ `script`ï¼Œä¸€ä¸ª Job å†…å¯ç”¨çš„å‚æ•°è§ [Job keywords](https://docs.gitlab.com/ee/ci/yaml/#job-keywords)ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºï¼ˆæœ€å¥½æ˜¯åœ¨æœ¬åœ°å·¥ä½œåŒºåˆ›å»ºè€Œä¸æ˜¯çº¿ä¸Šï¼Œå› ä¸ºæœ¬åœ°æäº¤æ›´æ”¹ push åä¼šç›´æ¥è¿è¡Œç®¡é“æ“ä½œï¼Œæ–¹ä¾¿æŸ¥çœ‹æ•ˆæœï¼‰`.gitlab-ci.yml` æ–‡ä»¶ï¼Œç¼–å†™è„šæœ¬ï¼š

```yml
stages: 
  - build
  - deploy

build_site:
  stage: build
  script:
    # æ‰“å°å†…å®¹
    - echo "Start build"
    # å®‰è£…ä¾èµ–
    - rm -fr ./node_modules && npm install --registry=https://registry.npm.taobao.org
    # æ‰“åŒ…æ„å»º
    - npm run build
    - echo "Build done"
  only: 
    - master              # åªåœ¨ master åˆ†æ”¯ä»£ç å‘ç”Ÿå˜åŒ–æ—¶æ‰æ‰§è¡Œè¯¥ Job
  tags:
    - test                # æŒ‡å®š Runner çš„ tagï¼ˆæ³¨å†Œ Runner æ—¶æŒ‡å®šçš„ï¼‰
  artifacts:
    - expire_in: 1 week
    - paths:
      - dist/

deploy_site:
  stage: deploy
  script:
    - echo "Start deploy"
    # å°†æ„å»ºå¥½åçš„ dist ç›®å½•æ‹·è´åˆ° NGINX çš„æŒ‚è½½ç›®å½•ä¸Š
    - rm -rf /var/www/cicd-test
    - cp -r ./dist /var/www/cicd-test
  only:
    - master
  dependencies:
    - build_site          # æ¥æ”¶ build_site ä¼ é€’çš„äº§ç‰©
  tags:
    - test
```

æŒ‰æ€è·¯ï¼Œbuild é˜¶æ®µåº”æ‰§è¡Œæ‰“åŒ…äº§ç”Ÿä¸€ä¸ª dist ç›®å½•ï¼Œå†åœ¨æ¥ä¸‹æ¥çš„ deploy é˜¶æ®µæŒ‚è½½åˆ° NGINX çš„ç›®å½•ä¸Šå°±å®Œæˆäº†é¡¹ç›®éƒ¨ç½²ï¼Œä½†ç®¡é“çš„è®¾å®šæ˜¯æ¯ä¸ª Job å¯åŠ¨æ—¶éƒ½ä¼šåŒæ­¥ä»“åº“ä¸­çš„ `.gitignore` æ–‡ä»¶å¹¶è‡ªåŠ¨åˆ é™¤å…¶ä¸­å£°æ˜çš„æ–‡ä»¶â€”â€”dist ç›®å½•åœ¨ deploy é˜¶æ®µå¼€å§‹çš„æ—¶å€™å°±æ²¡äº†ã€‚

æ‰€ä»¥è„šæœ¬æ–‡ä»¶ä¸­éœ€è¦ä½¿ç”¨åˆ°å¦ä¸€ä¸ªå‚æ•° [`artifacts`](https://docs.gitlab.com/ee/ci/yaml/README.html#artifacts)ï¼Œæˆ‘å°†å®ƒè¯‘ä¸ºâ€œ**äº§ç‰©**â€ï¼Œè¡¨ç¤º**åœ¨å½“å‰ Job æ‰§è¡ŒæˆåŠŸ/å¤±è´¥åå¯ä»¥å°†æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½•ä¿å­˜åˆ° GitLab**ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸‹é¢çš„ Jobs ä¸­ä½¿ç”¨äº†ï¼Œä¸Šé¢è¿˜æŒ‡å®šäº†äº§ç‰©çš„è¿‡æœŸæ—¶é—´ã€‚dependencies ç”¨äºåœ¨å½“å‰çš„ Job ä¸­æ¥æ”¶å‰é¢çš„äº§ç‰©ï¼Œé»˜è®¤å‰é¢çš„æ‰€æœ‰ Jobs é‡Œçš„äº§ç‰©éƒ½ä¼šå¾€åä¼ é€’ï¼Œè®¾ä¸ºç©ºæ•°ç»„åˆ™ä¸æ¥æ”¶ä»»ä½•äº§ç‰©ã€‚

push ä¹‹å‰è¿˜éœ€è¦è®¾å®šä¸€ä¸‹ `/var/www` ç›®å½•çš„æƒé™ï¼Œè¯¥ç›®å½•é»˜è®¤å±äº root ç”¨æˆ·ï¼Œè€Œ Runner è¿è¡Œæ—¶çš„ç”¨æˆ·æ˜¯ gitlab-runnerï¼Œæƒé™äº¤æ¥ï¼š

```s
$ chown -hR gitlab-runner:gitlab-runner /var/www/
```

æ¨é€æ›´æ”¹åï¼Œåœ¨é¡¹ç›®çš„ CI/CD é¢æ¿ä¸­å¯æŸ¥çœ‹ç®¡é“å’Œ Jobs çš„è¯¦ç»†æƒ…å†µï¼š

![gitlab-ui.png](/images/gitlab-ci-cd_gitlab-ui.png "CI/CD é¢æ¿")

ç‚¹å‡»å•ç‹¬çš„ Job ä¹Ÿå¯æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæƒ…å†µï¼ŒUI ä¸Šçš„æ“ä½œå°±ä¸å¤šä»‹ç»äº†ï¼Œå½“ç®¡é“å†…æ‰€æœ‰çš„é˜¶æ®µéƒ½æ‰§è¡Œå®Œæ¯•åï¼ŒVue é¡¹ç›®å³éƒ¨ç½²æˆåŠŸï¼š

![deploy-success.png](/images/gitlab-ci-cd_deploy-success.png "éƒ¨ç½²æˆåŠŸ")

è¿˜æœ‰ä¸€ç‚¹å€¼å¾—ä¸€æï¼Œæˆ‘åœ¨å°†æ–°çš„ dist ç›®å½•æ‹·è´åˆ° NGINX æŒ‚è½½ç›®å½•æ—¶å…ˆæ˜¯ç”¨çš„ `cp` å‘½ä»¤ç»“åˆ `-fr` å‚æ•°ï¼Œè¡¨ç¤ºå¤åˆ¶å¹¶..è¦†ç›–..åŸæœ‰çš„ç›®å½•ã€‚å‡ºç°çš„é—®é¢˜æ˜¯æ¯æ¬¡ç®¡é“è¿è¡Œå®Œæˆåéƒ½ä¸èƒ½åŠæ—¶åœ°æ›´æ–°åº”ç”¨çš„å†…å®¹ï¼Œå[æŸ¥è¯¢å¾—çŸ¥](https://cloud.tencent.com/developer/article/1179348)æ˜¯ç”± `cp` å‘½ä»¤çš„åº•å±‚åŸç†å¯¼è‡´çš„ï¼Œç®€å•æ¥è¯´å°±æ˜¯ **`cp -fr` å¹¶ä¸èƒ½ä¿è¯å®‰å…¨åœ°æ›¿æ¢åŸæœ‰æ–‡ä»¶**ï¼Œé‚ä½¿ç”¨äº† `rm` + `cp` å‘½ä»¤ï¼Œä¸€åˆ‡æ­£å¸¸ğŸ‰ã€‚

## References & Resources
1. [GitLab CI/CD | GitLab](https://docs.gitlab.com/ee/ci/) 
2. [CI/CDæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ç†è§£æŒç»­é›†æˆã€æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½² | Red Hat](https://www.redhat.com/zh/topics/devops/what-is-ci-cd)
3. [ç»™äº§å“ç»ç†è®²è®²ï¼Œä»€ä¹ˆæ˜¯æŒç»­äº¤ä»˜å’ŒDevOps | acejoy](https://blog.jjonline.cn/linux/238.html)
4. [How to auto deploy a Vue application using GitLab CI/CD on Ubuntu 18.04 | Michael Okoh](https://blog.logrocket.com/how-to-auto-deploy-a-vue-application-using-gitlab-ci-cd-on-ubuntu/)

[^1]: å›¾æº https://www.mindtheproduct.com/what-the-hell-are-ci-cd-and-devops-a-cheatsheet-for-the-rest-of-us/
[^2]: æ‰§è¡Œè€…å¯ä»¥å†³å®š Runner æ‰§è¡Œå™¨å¯ä»¥è¿›è¡Œçš„æ“ä½œï¼Œè¯¦è§ [Executors](https://docs.gitlab.com/runner/executors/README.html)ã€‚